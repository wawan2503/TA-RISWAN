<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kalkulator Antena Mikrostrip Patch Segitiga</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <div class="sheet">
    <div class="header-pill">
      <div class="header-text">
        KALKULATOR ANTENA<br>
        MIKROSTRIP PATCH SEGITIGA
      </div>
    </div>
    <div class="meta-row">
      <span class="chip">Patch Triangle</span>
      <span class="chip">Microstrip</span>
      <span class="chip">Calculator</span>
    </div>

    <div class="main">
      <!-- LEFT -->
      <div class="left">
        <div class="section-title">Parameter Masukan</div>
        <form method="post" action="{{ url_for('calculator') }}" class="calc-grid" id="calcForm">
          <!-- Row 1: FREKUENSI + A -->
          <div class="lbl">FREKUENSI</div>
          <div class="val a-box">
            <div class="a-tag">A</div>
            <select name="freq" id="freqSelect">
              {% for f in freq_options %}
                <option value="{{f}}" {% if form.freq == f %}selected{% endif %}>{{f}} GHz</option>
              {% endfor %}
            </select>
          </div>

          <!-- Row 2 -->
          <div class="lbl">Bahan substrat</div>
          <div class="val">
            <input value="{{ form.substrat }}" disabled>
          </div>

          <!-- Row 3 -->
          <div class="lbl">Tebal substrat (h)</div>
          <div class="val">
            <input name="h" value="{{ form.h }}">
          </div>

          <!-- Row 4 -->
          <div class="lbl">Konstanta dielektrik (er)</div>
          <div class="val">
            <input name="er" value="{{ form.er }}">
          </div>

          <!-- Row 5 -->
          <div class="lbl">Impedansi konduktor</div>
          <div class="val">
            <input value="{{ form.z0 }}" disabled>
          </div>

          <!-- Row 6: t (ketentuan) -->
          <div class="lbl">Tebal konduktor (t)</div>
          <div class="val">
            <input value="0.035 mm" disabled>
          </div>

          <input type="hidden" name="wo" value="{{ form.wo }}">

          <button class="btn-hit" type="submit">HITUNG</button>
        </form>

        <details class="info-card">
          <summary>Keterangan & Rumus</summary>
          <div class="info-grid">
            <div class="info-block">
              <div class="info-title">Keterangan</div>
              <ul>
                <li><b>A</b> = Pilihan frekuensi (1.8, 2.2, 2.3, 2.4, 3.3 GHz)</li>
                <li><b>B</b> = Hasil perhitungan</li>
              </ul>
            </div>
            <div class="info-block">
              <div class="info-title">Ringkasan Rumus Final</div>
              <div class="formula">a = (2 x c) / (3 x f x sqrt(er))</div>
              <div class="formula">ws = ls = 1.5 x a</div>
              <div class="formula">lambda0 = c / f</div>
              <div class="formula">eff = (er+1)/2 + (er-1)/2 x ( 1 / sqrt(1 + 12h/Wo) )</div>
              <div class="formula">lambda_g = c / ( f x sqrt(eff) )</div>
              <div class="formula">lf = lambda_g / 2</div>
              <div class="info-note">Default (FR-4, h=1.6 mm, Wo=3 mm): eff ~ 3.3</div>
            </div>
          </div>
        </details>

        <!-- B box -->
        <div class="box b-box">
          <div class="box-letter b-letter">B</div>

          {% if hasil %}
          <div class="result-list" id="resultArea">
            <div class="r"><span>Wo</span><b>{{ "%.2f"|format(hasil.wo) }} mm</b></div>
            <div class="r"><span>lf</span><b>{{ "%.2f"|format(hasil.lf_mm) }} mm</b></div>
            <div class="r"><span>a</span><b>{{ "%.2f"|format(hasil.a_mm) }} mm</b></div>
            <div class="r"><span>ws</span><b>{{ "%.2f"|format(hasil.ws_mm) }} mm</b></div>
            <div class="r"><span>ls</span><b>{{ "%.2f"|format(hasil.ls_mm) }} mm</b></div>
          </div>
          {% else %}
            <div class="b-placeholder" id="resultArea">Hasil perhitungan (Wo, lf, a, ws, ls) muncul di sini</div>
          {% endif %}
        </div>

      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="section-title">Gambar Antena</div>
        <div class="box c-box">
          <img src="{{ url_for('static', filename=img_c) }}" alt="Gambar Antena (C)" id="imgC">
        </div>

        <div class="plots-grid" aria-label="Gambar hasil CST">
          <div class="box thumb-box">
            <img src="{{ url_for('static', filename=img_gain) }}" alt="Gain" id="imgGain">
          </div>
          <div class="box thumb-box">
            <img src="{{ url_for('static', filename=img_pola) }}" alt="Pola radiasi" id="imgPola">
          </div>
          <div class="box thumb-box">
            <img src="{{ url_for('static', filename=img_return_loss) }}" alt="Return Loss" id="imgReturnLoss">
          </div>
          <div class="box thumb-box">
            <img src="{{ url_for('static', filename=img_vswr) }}" alt="VSWR" id="imgVswr">
          </div>
        </div>
      </div>
    </div>
    <div class="creator center">Pembuat: Riswan Amin Sitorus (NIM 190402005)</div>
  </div>

  <script>
    const calcForm = document.getElementById("calcForm");
    const resultArea = document.getElementById("resultArea");
    const imgC = document.getElementById("imgC");
    const imgGain = document.getElementById("imgGain");
    const imgPola = document.getElementById("imgPola");
    const imgReturnLoss = document.getElementById("imgReturnLoss");
    const imgVswr = document.getElementById("imgVswr");
    const freqSelect = document.getElementById("freqSelect");
    const freqImageUrls = {{ freq_image_urls | tojson }};

    function updateImagesForFreq(freqValue) {
      const urls = freqImageUrls?.[freqValue];
      if (!urls) return;
      if (imgC) imgC.src = urls.antena;
      if (imgGain) imgGain.src = urls.gain;
      if (imgPola) imgPola.src = urls.pola;
      if (imgReturnLoss) imgReturnLoss.src = urls.return_loss;
      if (imgVswr) imgVswr.src = urls.vswr;
    }

    function setResultMessage(text) {
      if (!resultArea) return;
      resultArea.classList.remove("result-list");
      resultArea.classList.add("b-placeholder");
      resultArea.textContent = text;
    }

    function renderResults(hasil) {
      if (!resultArea) return;
      resultArea.classList.remove("b-placeholder");
      resultArea.classList.add("result-list");
      resultArea.innerHTML = `
        <div class="r"><span>Wo</span><b>${hasil.wo.toFixed(2)} mm</b></div>
        <div class="r"><span>lf</span><b>${hasil.lf_mm.toFixed(2)} mm</b></div>
        <div class="r"><span>a</span><b>${hasil.a_mm.toFixed(2)} mm</b></div>
        <div class="r"><span>ws</span><b>${hasil.ws_mm.toFixed(2)} mm</b></div>
        <div class="r"><span>ls</span><b>${hasil.ls_mm.toFixed(2)} mm</b></div>
      `;
    }

    if (calcForm) {
      calcForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(calcForm);
        try {
          const resp = await fetch("{{ url_for('calculator_api') }}", {
            method: "POST",
            body: formData
          });
          const data = await resp.json();
          if (!data.ok) {
            setResultMessage(data.message || "Gagal menghitung.");
            return;
          }
          renderResults(data.hasil);
          if (imgC) imgC.src = data.imgs?.antena || data.img_c;
          if (imgGain) imgGain.src = data.imgs?.gain;
          if (imgPola) imgPola.src = data.imgs?.pola || data.img_d;
          if (imgReturnLoss) imgReturnLoss.src = data.imgs?.return_loss;
          if (imgVswr) imgVswr.src = data.imgs?.vswr;
        } catch (err) {
          setResultMessage("Gagal menghubungi server.");
        }
      });
    }

    if (freqSelect) {
      freqSelect.addEventListener("change", () => {
        updateImagesForFreq(freqSelect.value);
      });
      updateImagesForFreq(freqSelect.value);
    }
  </script>
</body>
</html>


